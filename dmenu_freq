#!/usr/bin/env bash
#
# runs dmenu_run with most commonly used programs listed first.
# appending a "!" runs the command with sudo permissions
# appending a ";" runs the command in a terminal
#
###

DMENU='dmenu -i -b -h 18 -fn "Sans-8"'
TERM='urxvt -e bash -ic'

CACHE="$HOME/.dmenu_cache_recent"
touch $CACHE

MOST_USED=$(sort $CACHE | uniq -c | sort -nr | colrm 1 8)
RUN=$( (echo "$MOST_USED"; dmenu_path_c | grep -vxF "$MOST_USED") | $DMENU )

case $RUN in
    *\!\;) exec="$TERM 'sudo ${RUN/!;/} && bash'"
      ;;
    *\;\!) exec="$TERM 'sudo ${RUN/;!/} && bash'"
      ;;
    *\!)   exec="gksudo ${RUN/!/}"
      ;;
    *\;)   exec="$TERM '${RUN/;/} && bash'"
      ;;
    *)     exec="$RUN"
      ;;
esac

eval $exec
if [[ $? == 0 ]]; then
  (echo $RUN; head -n199 $CACHE) > $CACHE.$$ && mv $CACHE.$$ $CACHE
else
  exit 1
fi

exit 0
